---
description: Guidelines and best practices for building Convex projects, including database schema design, queries, mutations, and real-world examples
globs: **/*.ts,**/*.tsx,**/*.js,**/*.jsx
---

# Convex guidelines

## Function guidelines

### New function syntax

- ALWAYS use the new function syntax for Convex functions. For example:

```typescript
import { query } from "./_generated/server";
import { v } from "convex/values";
export const f = query({
  args: {},
  returns: v.null(),
  handler: async (ctx, args) => {
    // Function body
  },
});
```

### Http endpoint syntax

- HTTP endpoints are defined in `convex/http.ts` and require an `httpAction` decorator. For example:

```typescript
import { httpRouter } from "convex/server";
import { httpAction } from "./_generated/server";
const http = httpRouter();
http.route({
  path: "/echo",
  method: "POST",
  handler: httpAction(async (ctx, req) => {
    const body = await req.bytes();
    return new Response(body, { status: 200 });
  }),
});
```

### Validators

- Below is an example of an array validator:

```typescript
import { mutation } from "./_generated/server";
import { v } from "convex/values";

export default mutation({
  args: {
    simpleArray: v.array(v.union(v.string(), v.number())),
  },
  handler: async (ctx, args) => {
    //...
  },
});
```

- Always use the `v.null()` validator when returning a null value.
- Here are the valid Convex types along with their respective validators:
  | Convex Type | TS/JS type | Example Usage | Validator | Notes |
  | ----------- | ------------ | ---------------------- | ---------------------------- | ------------------------------------------------------ |
  | Id | string | `doc._id` | `v.id(tableName)` | |
  | Null | null | `null` | `v.null()` | Use `null` instead of `undefined` |
  | Int64 | bigint | `3n` | `v.int64()` | |
  | Float64 | number | `3.1` | `v.number()` | |
  | Boolean | boolean | `true` | `v.boolean()` | |
  | String | string | `"abc"` | `v.string()` | |
  | Bytes | ArrayBuffer | `new ArrayBuffer(8)` | `v.bytes()` | |
  | Array | Array | `[1, 3.2, "abc"]` | `v.array(values)` | Max 8192 values |
  | Object | Object | `{a: "abc"}` | `v.object({property: value})`| |
  | Record | Record | `{"a": "1", "b": "2"}` | `v.record(keys, values)` | |

### Function registration

- Use `internalQuery`, `internalMutation`, and `internalAction` to register internal functions. These are private.
- Use `query`, `mutation`, and `action` to register public functions.
- ALWAYS include argument and return validators for all Convex functions.

### Function calling

- Use `ctx.runQuery` to call a query from a query, mutation, or action.
- Use `ctx.runMutation` to call a mutation from a mutation or action.
- Use `ctx.runAction` to call an action from an action.
- ONLY call an action from another action if you need to cross runtimes (e.g. from V8 to Node).
- All of these calls take in a `FunctionReference`. Do NOT pass the callee function directly.

### Function references

- Use `api` for public functions, `internal` for private functions.
- Convex uses file-based routing: `convex/example.ts` named `f` â†’ `api.example.f`.

## Schema guidelines

- Always define your schema in `convex/schema.ts`.
- System fields `_creationTime` and `_id` are automatically added.
- Always include all index fields in the index name.
- Index fields must be queried in the same order they are defined.

## Query guidelines

- Do NOT use `filter` in queries. Use `withIndex` instead.
- Convex queries do NOT support `.delete()`. Use `.collect()` then iterate.
- Use `.unique()` to get a single document.

## Mutation guidelines

- Use `ctx.db.replace` to fully replace a document.
- Use `ctx.db.patch` to shallow merge updates.

## Action guidelines

- Always add `"use node";` to files with actions that use Node.js built-in modules.
- Never use `ctx.db` inside an action. Actions don't have direct DB access.

## Scheduling guidelines

- Only use `crons.interval` or `crons.cron` methods for cron jobs.
- Both take FunctionReferences, not direct function references.

## File storage guidelines

- `ctx.storage.getUrl()` returns a signed URL for a file, or `null` if not found.
- Query the `_storage` system table for file metadata.
